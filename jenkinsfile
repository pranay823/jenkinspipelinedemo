import groovy.json.JsonSlurperClassic

node{
    //  def BUILD_NUMBER = env.BUILD_NUMBER
    // def RUN_ARTIFACT_DIR = "tests/${BUILD_NUMBER}"
    // def SFDC_USERNAME
    env.PATH = "/usr/local/bin:/opt/homebrew/bin:/usr/bin:/bin:/usr/sbin:/sbin:${env.PATH}"


    def HUB_ORG = env.HUB_ORG
    def SFDC_HOST = env.SFDC_HOST
    def JWT_KEY_CRED_ID = env.JWT_CRED_ID
    def CONNECTED_APP_CONSUMER_KEY = env.CONNECTED_APP_CONSUMER_KEY

      println "================== Salesforce CI/CD Environment =================="
    println "JWT Credential ID        : ${JWT_KEY_CRED_ID}"
    println "Salesforce Username      : ${HUB_ORG}"
    println "Salesforce Host          : ${SFDC_HOST}"
    println "Connected App Consumer Key: ${CONNECTED_APP_CONSUMER_KEY}"
    println "================================================================="

    stage('Checkout Source Code') {
        checkout scm
    }

    withCredentials([file(credentialsId: JWT_KEY_CRED_ID, variable: 'jwt_key_file')]) {
        stage('Authorize Org') {

            def rc = 0

            if (isUnix()) {
                rc = sh(returnStatus: true, script: """
                    sfdx force:auth:jwt:grant \
                    --clientid ${CONNECTED_APP_CONSUMER_KEY} \
                    --username ${HUB_ORG} \
                    --jwtkeyfile ${jwt_key_file} \
                    -d \
                    --instanceurl ${SFDC_HOST}
                """)
            } else {
                rc = bat(returnStatus: true, script:
                    "sfdx force:auth:jwt:grant --clientid ${CONNECTED_APP_CONSUMER_KEY} --username ${HUB_ORG} --jwtkeyfile \"${jwt_key_file}\" -d --instanceurl ${SFDC_HOST}"
                )
            }

            if (rc != 0) {
                error "‚ùå Salesforce authentication failed!"
            }

            println "‚úî Salesforce authentication successful."
        }
    }

    stage('Convert Salesforce DX To Metadata API Format') {
        println "üì¶ Converting SFDX project to MDAPI..."

        def srccode

        if (isUnix()) {
            srccode = sh(returnStdout: true, script:
                "sfdx force:source:convert -r force-app -d ./src"
            ).trim()
        } else {
            srccode = bat(returnStdout: true, script:
                "sfdx force:source:convert -r force-app -d ./src"
            )
        }

        println srccode
    }

    stage('Deploy Metadata to Target Org') {

        println "üöÄ Deploying metadata to Salesforce..."

        def sourcepush

        if (isUnix()) {
            sourcepush = sh(returnStdout: true, script:
                "sf project deploy start --metadata-dir ./src --target-org ${HUB_ORG} --wait 10"
            ).trim()
        } else {
            sourcepush = bat(returnStdout: true, script:
                "sf project deploy start --metadata-dir ./src --target-org ${HUB_ORG} --wait 10"
            )
        }

        println sourcepush
    }

        stage('Check Deployment Status') {

        println("üîç Checking Deployment Status...")

        def statusDep

        if (isUnix()) {
            statusDep = sh(returnStdout: true, script:
                "sf project deploy report --use-most-recent --target-org ${HUB_ORG} --json"
            ).trim()
        } else {
            statusDep = bat(returnStdout: true, script:
                "sf project deploy report --use-most-recent --target-org ${HUB_ORG} --json"
            )
        }

        println "üìå Deployment Status:"
        println statusDep

        println "‚è≥ Waiting 60 seconds before rechecking..."
        sleep 60

        println("üîÅ Checking Deployment Status Again...")

        def statusDep1

        if (isUnix()) {
            statusDep1 = sh(returnStdout: true, script:
                "sf project deploy report --use-most-recent --target-org ${HUB_ORG} --json"
            ).trim()
        } else {
            statusDep1 = bat(returnStdout: true, script:
                "sf project deploy report --use-most-recent --target-org ${HUB_ORG} --json"
            )
        }

        println "üìå Updated Deployment Status:"
        println statusDep1
    }

    stage('Final') {
        println "üéâ Deployment Completed Successfully!"
    }


}